<template>
  <div class="workspace-container">
    <Sidebar 
      @toggle-notification="showNotificationPanel = !showNotificationPanel"
      @toggle-user="showUserPanel = !showUserPanel"
    />
    
    <!-- å¯è§†åŒ–æ¨¡æ¿è¾¹æ  - å›ºå®šåœ¨å¯¼èˆªæ å³è¾¹ -->
    <aside class="template-sidebar">
      <div class="template-header">
        <h3>å¯è§†åŒ–æ¨¡æ¿</h3>
      </div>
      <div class="template-grid">
        <div 
          v-for="(image, index) in thumbnails" 
          :key="index" 
          class="template-item" 
          :class="{ active: selectedTemplate === index }"
          @click="selectTemplate(index)"
        >
          <img :src="`/assets/index_images/${image}`" :alt="`æ¨¡æ¿ ${index + 1}`" class="template-image">
          <span class="template-label">{{ labels[index % labels.length] }}</span>
        </div>
      </div>
    </aside>
    
    <!-- é®ç½©å±‚ -->
    <div 
      v-if="showNotificationPanel || showUserPanel" 
      class="overlay" 
      @click="closeAllPanels"
    ></div>

    <!-- é€šçŸ¥é¢æ¿ -->
    <div class="notification-panel" :class="{ active: showNotificationPanel }">
      <div class="notification-header">
        <h3>é€šçŸ¥</h3>
        <button class="close-btn" @click="showNotificationPanel = false">&times;</button>
      </div>
      <div class="notification-list">
        <div class="notification-item unread">
          <div class="notification-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="M22 11.08V12C22 17.52 17.52 22 12 22C6.48 22 2 17.52 2 12C2 6.48 6.48 2 12 2C14.44 2 16.66 2.89 18.38 4.34" stroke="currentColor" stroke-width="2"/>
              <path d="M22 4L12 14.01L9 11.01" stroke="currentColor" stroke-width="2"/>
            </svg>
          </div>
          <div class="notification-content">
            <p>è®ºæ–‡åˆ†æå®Œæˆ</p>
            <span class="notification-time">5åˆ†é’Ÿå‰</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ç”¨æˆ·é¢æ¿ -->
    <div class="user-panel" :class="{ active: showUserPanel }">
      <div class="user-info">
        <img src="/default-avatar.svg" alt="ç”¨æˆ·å¤´åƒ" class="user-avatar">
        <div class="user-details">
          <h4>è®¿å®¢ç”¨æˆ·</h4>
          <p>æœªç™»å½•</p>
        </div>
      </div>
      <div class="user-menu">
        <a href="#profile" class="menu-item">ä¸ªäººèµ„æ–™</a>
        <a href="#settings" class="menu-item">è®¾ç½®</a>
        <div class="menu-divider"></div>
        <a href="#login" class="menu-item">ç™»å½•</a>
      </div>
    </div>

    <!-- ä¸»å·¥ä½œåŒº -->
    <main class="workspace">
      <!-- é¡¶éƒ¨æœç´¢åŒºåŸŸ -->
      <div class="workspace-header" v-show="!showPdfPreview">
        <div class="search-wrapper">
          <button class="upload-btn" @click="triggerFileUpload" title="ä¸Šä¼ PDF">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="M12 15V3M12 3L8 7M12 3L16 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M2 17L2 19C2 20.1046 2.89543 21 4 21L20 21C21.1046 21 22 20.1046 22 19V17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
          <input 
            type="text" 
            class="search-input" 
            v-model="searchQuery"
            @keypress.enter="handleSearch"
            placeholder="è¾“å…¥pdfé“¾æ¥æˆ–è€…ç›´æ¥æœç´¢è®ºæ–‡"
          >
          <button class="search-btn" @click="handleSearch">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z" 
                    stroke="currentColor" 
                    stroke-width="2" 
                    stroke-linecap="round"/>
            </svg>
        </div>
      </div>

      <!-- PDFé¢„è§ˆåŒºåŸŸ -->
      <div class="pdf-preview-section" v-if="showPdfPreview">
        <!-- æµ®åŠ¨æŒ‰é’®ç»„ -->
        <div class="floating-controls">
          <button class="back-btn" @click="closePdfPreview">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            è¿”å›åˆ—è¡¨
          </button>
        </div>
        <!-- PDFå†…å®¹åŒºåŸŸ -->
        <div class="preview-content">
          <!-- åœ†å½¢è¿›åº¦åŠ è½½ -->
          <div v-if="isDownloading" class="pdf-loading">
            <div class="circle-wrapper">
              <svg class="progress-ring" width="120" height="120">
                <circle class="progress-ring__background" stroke="#ecf0f1" stroke-width="10" fill="transparent" r="52" cx="60" cy="60" />
                <circle class="progress-ring__progress" :stroke="progressColor" stroke-width="10" fill="transparent" r="52" cx="60" cy="60"
                        :style="{ strokeDasharray: circumference, strokeDashoffset: dashOffset }" stroke-linecap="round" />
              </svg>
              <div class="progress-text">{{ downloadProgress }}%</div>
            </div>
          </div>

          <!-- Vue PDF é¢„è§ˆ -->
          <div v-if="!showVisualization" class="pdf-viewer" style="width:100%; height:100%; overflow: auto;">
            <div v-if="pdfBlobUrl" class="pdf-embed-container">
              <vue-pdf-embed
                :source="pdfBlobUrl"
                class="pdf-document"
              />
            </div>
            <p v-else-if="!isDownloading" style="color:#95a5a6; text-align: center; padding: 20px;">å‡†å¤‡é¢„è§ˆPDF...</p>
          </div>

          <div v-else class="visualization-result">
            <img :src="visualizationImage" alt="å¯è§†åŒ–ç»“æœ" class="visualization-image">
          </div>
        </div>
      </div>

      <!-- å†…å®¹å±•ç¤ºåŒºåŸŸ -->
      <div class="content-section" v-show="!showPdfPreview">
        <!-- æ¬¢è¿ç•Œé¢ -->
        <div class="welcome-view" v-if="currentView === 'welcome'">
          <div class="welcome-icon">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none">
              <path d="M13 2L3 14H12L11 22L21 10H12L13 2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
          </div>
          <h2>å¼€å§‹ä½ çš„è®ºæ–‡åˆ†æä¹‹æ—…</h2>
          <p>ä¸Šä¼ PDFæ–‡ä»¶ã€è¾“å…¥é“¾æ¥æˆ–æœç´¢è®ºæ–‡å…³é”®è¯</p>
        </div>

        <!-- æœç´¢ç»“æœåˆ—è¡¨ -->
        <div class="search-results" v-if="currentView === 'search'">
          <h3 class="results-title">æœç´¢ç»“æœ</h3>
          <div class="results-list">
            <div 
              v-for="result in paginatedResults" 
              :key="result.title" 
              class="result-item"
              @click="selectPaper(result)"
            >
              <h3 class="result-title">{{ result.title }}</h3>
              <p class="result-authors">{{ result.authors }}</p>
              <p class="result-abstract">{{ result.abstract }}</p>
              <div class="result-meta">
                <span>ğŸ“… {{ result.year }}</span>
                <span>ğŸ“Š å¼•ç”¨: {{ result.citations }}</span>
              </div>
            </div>
          </div>
          <!-- åˆ†é¡µ -->
          <div class="pagination" v-if="totalPages > 1">
            <span class="pagination-info">æ˜¾ç¤º {{ startItem }}-{{ endItem }} / å…± {{ allResults.length }} æ¡</span>
            <button class="pagination-btn" @click="goToPage(1)" :disabled="currentPage === 1">é¦–é¡µ</button>
            <button class="pagination-btn" @click="goToPage(currentPage - 1)" :disabled="currentPage === 1">ä¸Šä¸€é¡µ</button>
            <div class="pagination-pages">
              <button 
                v-for="page in pageButtons" 
                :key="page"
                class="pagination-btn" 
                :class="{ active: page === currentPage }"
                @click="goToPage(page)"
              >
                {{ page }}
              </button>
            </div>
            <button class="pagination-btn" @click="goToPage(currentPage + 1)" :disabled="currentPage === totalPages">ä¸‹ä¸€é¡µ</button>
            <button class="pagination-btn" @click="goToPage(totalPages)" :disabled="currentPage === totalPages">å°¾é¡µ</button>
          </div>
        </div>
      </div>
    </main>

    <!-- éšè—çš„æ–‡ä»¶ä¸Šä¼ è¾“å…¥ -->
    <input type="file" ref="fileInput" accept=".pdf" style="display: none;" @change="handleFileUpload">
  </div>
</template>

<script setup>
import { ref, computed, onMounted, onUnmounted, nextTick } from 'vue'
import { useRoute } from 'vue-router'
import { apiService } from '@/api'
import { isURL } from '@/utils/helpers'
import Sidebar from '@/components/Sidebar.vue'
import VuePdfEmbed from 'vue-pdf-embed'

const route = useRoute()

const showNotificationPanel = ref(false)
const showUserPanel = ref(false)
const searchQuery = ref('')
const currentView = ref('welcome')
const thumbnails = ref([])
const labels = ['å…³ç³»ç½‘å¯è§†åŒ–', 'è¯äº‘å¯è§†åŒ–', 'æŒ‡æ ‡å¯¹æ¯”', 'æ—¶é—´çº¿å›¾', 'æ•°æ®åˆ†å¸ƒ', 'æµç¨‹å›¾', 'çŸ©é˜µçƒ­åŠ›å›¾', 'é›·è¾¾å›¾']

// æ–°å¢çŠ¶æ€
const selectedTemplate = ref(null)
const selectedPaperTitle = ref('')
const showPdfPreview = ref(false)
const showVisualization = ref(false)
const isProcessing = ref(false)
const visualizationImage = ref('')
// PDF ä¸‹è½½ä¸é¢„è§ˆ
const isDownloading = ref(false)
const downloadProgress = ref(0)
const pdfBlobUrl = ref('')
// åœ†å½¢è¿›åº¦å‚æ•°
const radius = 52
const circumferenceVal = 2 * Math.PI * radius
const circumference = `${circumferenceVal}px`
const progressColor = '#3498db'
const dashOffset = computed(() => {
  const pct = Math.max(0, Math.min(100, downloadProgress.value))
  const val = circumferenceVal - (pct / 100) * circumferenceVal
  return `${val}px`
})

const allResults = ref([])
const currentPage = ref(1)
const itemsPerPage = 10
const fileInput = ref(null)

const totalPages = computed(() => Math.ceil(allResults.value.length / itemsPerPage))
const startItem = computed(() => (currentPage.value - 1) * itemsPerPage + 1)
const endItem = computed(() => Math.min(currentPage.value * itemsPerPage, allResults.value.length))

const paginatedResults = computed(() => {
  const start = (currentPage.value - 1) * itemsPerPage
  return allResults.value.slice(start, start + itemsPerPage)
})

const pageButtons = computed(() => {
  const maxButtons = 5
  let start = Math.max(1, currentPage.value - Math.floor(maxButtons / 2))
  let end = Math.min(totalPages.value, start + maxButtons - 1)
  if (end - start < maxButtons - 1) {
    start = Math.max(1, end - maxButtons + 1)
  }
  return Array.from({ length: end - start + 1 }, (_, i) => start + i)
})

const loadThumbnails = async () => {
  try {
    const data = await apiService.getIndexImages()
    if (data.images) {
      thumbnails.value = data.images
    }
  } catch (error) {
    console.error('åŠ è½½ç¼©ç•¥å›¾å¤±è´¥:', error)
  }
}

const handleSearch = async () => {
  const query = searchQuery.value.trim()
  if (!query) return

  currentView.value = 'search'
  try {
    const data = await apiService.searchPapers(query)
    const results = Array.isArray(data?.results) ? data.results : []
    allResults.value = results.map(r => ({
      title: r.title,
      authors: r.authors,
      abstract: r.abstract,
      year: r.year,
      citations: r.citations || 0,
      url: r.url,
      pdf_url: r.pdf_url
    }))
  } catch (error) {
    console.error('æœç´¢å¤±è´¥:', error)
    allResults.value = []
  }
  currentPage.value = 1
}

const generateMockResults = (query) => {
  const mockResults = []
  for (let i = 1; i <= 20; i++) {
    mockResults.push({
      title: `å…³äº"${query}"çš„ç ”ç©¶è®ºæ–‡ ${i}`,
      authors: 'Zhang Wei, Li Ming, Wang Fang',
      abstract: 'è¿™æ˜¯ä¸€ç¯‡å…³äºäººå·¥æ™ºèƒ½å’Œæœºå™¨å­¦ä¹ çš„ç ”ç©¶è®ºæ–‡ã€‚æœ¬æ–‡æ¢è®¨äº†æ·±åº¦å­¦ä¹ åœ¨è‡ªç„¶è¯­è¨€å¤„ç†ä¸­çš„åº”ç”¨ã€‚',
      year: 2020 + (i % 5),
      citations: Math.floor(Math.random() * 100)
    })
  }
  return mockResults
}

const goToPage = (page) => {
  if (page < 1 || page > totalPages.value || page === currentPage.value) return
  currentPage.value = page
}

const triggerFileUpload = () => {
  fileInput.value.click()
}

const handleFileUpload = (event) => {
  const file = event.target.files[0]
  if (file && file.type === 'application/pdf') {
    console.log('å·²é€‰æ‹©æ–‡ä»¶:', file.name)
  }
}

const selectTemplate = (index) => {
  selectedTemplate.value = index
  console.log('é€‰ä¸­æ¨¡æ¿:', labels[index % labels.length])
  // é€šçŸ¥å†…ç½®viewerå¯ç”¨â€œåº”ç”¨å¯è§†åŒ–â€æŒ‰é’®
  if (viewerFrame.value && viewerFrame.value.contentWindow) {
    viewerFrame.value.contentWindow.postMessage({ type: 'set-apply-enabled', enabled: true }, '*')
  }
}

const selectPaper = async (paper) => {
  selectedPaperTitle.value = paper.title
  showPdfPreview.value = true
{{ ... }}
  pdfBlobUrl.value = ''
  isDownloading.value = true
  downloadProgress.value = 0
  try {
    const resp = await apiService.proxyPdf(paper.pdf_url, (e) => {
      if (e && e.total) {
        downloadProgress.value = Math.min(100, Math.round((e.loaded / e.total) * 100))
      }
    })
    // Axios å·²è¿”å› Blob
    const blob = resp
    // åˆ›å»ºblob URL
    pdfBlobUrl.value = URL.createObjectURL(blob)
  } catch (err) {
    console.error('PDFä¸‹è½½å¤±è´¥:', err)
  } finally {
    isDownloading.value = false
  }
}

const closePdfPreview = () => {
  showPdfPreview.value = false
  showVisualization.value = false
  // é‡Šæ”¾blob URL
  if (pdfBlobUrl.value) {
    URL.revokeObjectURL(pdfBlobUrl.value)
    pdfBlobUrl.value = ''
  }
}

const applyVisualization = async () => {
  isProcessing.value = true
  
  // æ¨¡æ‹Ÿå¤„ç†å»¶è¿Ÿ
  await new Promise(resolve => setTimeout(resolve, 2000))
  
  // è¿™é‡Œå°†æ¥ä¼šè°ƒç”¨APIç”Ÿæˆå¯è§†åŒ–
  visualizationImage.value = '/assets/index_images/visualization_sample.png'
  showVisualization.value = true
  isProcessing.value = false
}

const closeAllPanels = () => {
  showNotificationPanel.value = false
  showUserPanel.value = false
}

onMounted(() => {
  loadThumbnails()
  const query = route.query.q || route.query.url
  if (query) {
    searchQuery.value = query
    handleSearch()
  }
})
</script>

<style scoped>
/* é¢„è§ˆå®¹å™¨å†…çš„åŠ è½½æ ·å¼ */
.pdf-loading {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}
.circle-wrapper {
  position: relative;
  width: 140px;
  height: 140px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
.progress-ring {
  transform: rotate(-90deg);
}
.progress-ring__background,
.progress-ring__progress {
  transition: stroke-dashoffset 0.2s ease;
}
.progress-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -60%);
  font-size: 20px;
  font-weight: 600;
  color: #2c3e50;
}
.progress-subtext {
  position: absolute;
  top: calc(50% + 28px);
  left: 50%;
  transform: translateX(-50%);
  font-size: 12px;
  color: #7f8c8d;
}
.pdf-embed-container {
  max-width: 1100px;
  margin: 0 auto;
  padding: 16px;
  background: white;
  border-radius: 8px;
}

.pdf-document {
  width: 100%;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
</style>
